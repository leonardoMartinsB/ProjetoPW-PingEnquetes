@model List<Poll>
@{
    ViewData["Title"] = "Gerenciar Enquetes";
}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="~/css/gerenciar.css" asp-append-version="true" />
    @Html.AntiForgeryToken()
</head>
<body>
    <div class="containerr">
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                @TempData["SuccessMessage"]
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i>
                @TempData["ErrorMessage"]
            </div>
        }

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-number">@Model.Count</div>
                <div class="stat-label">Total de Enquetes</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">@Model.Count(p => p.IsActive)</div>
                <div class="stat-label">Ativas</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">@Model.Count(p => p.IsExpired)</div>
                <div class="stat-label">Expiradas</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">@Model.Sum(p => p.TotalVotes)</div>
                <div class="stat-label">Total de Votos</div>
            </div>
        </div>
        <div class="actions-bar">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar enquetes...">
            </div>
            <div>
                <a href="@Url.Action("Criar")" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Nova Enquete
                </a>
                <a href="@Url.Action("Listar")" class="btn btn-outline">
                    <i class="fas fa-list"></i>
                    Ver Todas
                </a>
            </div>
        </div>

        @if (Model.Any())
        {
            <div class="polls-grid" id="pollsGrid">
                @foreach (var poll in Model)
                {
                    <div class="poll-card" data-poll-question="@poll.Question.ToLower()">
                        <div class="poll-card-header">
                            <h3 class="poll-question">@poll.Question</h3>
                            <span class="poll-status @(poll.IsActive ? "status-active" : "status-expired")">
                                @(poll.IsActive ? "Ativa" : "Expirada")
                            </span>
                        </div>

                        <div class="poll-card-body">
                            @if (!string.IsNullOrEmpty(poll.Description))
                            {
                                <p style="color: #666; margin-bottom: 1rem; font-style: italic;">
                                    @poll.Description
                                </p>
                            }

                            <div class="poll-meta">
                                <div class="meta-item">
                                    <i class="fas fa-calendar-alt meta-icon"></i>
                                    <span>@poll.CreatedAt.ToString("dd/MM/yyyy")</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-clock meta-icon"></i>
                                    <span>@poll.CreatedAt.ToString("HH:mm")</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-stopwatch meta-icon"></i>
                                    <span>
                                        @if (poll.ExpiresAt.HasValue)
                                        {
                                            @poll.ExpiresAt.Value.ToString("dd/MM/yyyy HH:mm")
                                        }
                                        else
                                        {
                                            <text>Sem expiração</text>
                                        }
                                    </span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-list-ul meta-icon"></i>
                                    <span>@poll.Options.Count opções</span>
                                </div>
                            </div>

                            <div class="poll-stats">
                                <div class="poll-stat">
                                    <div class="poll-stat-number">@poll.TotalVotes</div>
                                    <div class="poll-stat-label">Votos</div>
                                </div>
                                <div class="poll-stat">
                                    <div class="poll-stat-number">@poll.ParticipantsCount</div>
                                    <div class="poll-stat-label">Participantes</div>
                                </div>
                                <div class="poll-stat">
                                    <div class="poll-stat-number">
                                        @if (poll.TotalVotes > 0)
                                        {
                                            @($"{Math.Round((double)poll.ParticipantsCount / poll.TotalVotes * 100)}%")
                                        }
                                        else
                                        {
                                            <text>0%</text>
                                        }
                                    </div>
                                    <div class="poll-stat-label">Participação</div>
                                </div>
                            </div>

                            <div class="poll-actions">
                                <a href="@Url.Action("Detalhes", new { id = poll.Id })" class="btn btn-primary">
                                    <i class="fas fa-eye"></i>
                                    Ver Detalhes
                                </a>
                                <button type="button" class="btn btn-danger" onclick="confirmDelete(@poll.Id, '@poll.Question')">
                                    <i class="fas fa-trash"></i>
                                    Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <i class="fas fa-poll empty-icon"></i>
                <h2 class="empty-title">Nenhuma enquete encontrada</h2>
                <p class="empty-text">Você ainda não criou nenhuma enquete. Que tal começar criando uma agora?</p>
                <a href="@Url.Action("Criar")" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Criar Primeira Enquete
                </a>
            </div>
        }
    </div>
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="modal-title">Confirmar Exclusão</h3>
            <p class="modal-text">
                Tem certeza que deseja excluir a enquete:<br>
                <strong id="pollToDelete"></strong>
            </p>
            <p class="modal-text" style="color: var(--danger-color);">
                <i class="fas fa-warning"></i>
                Esta ação não pode ser desfeita!
            </p>
            <div class="modal-buttons">
                <button type="button" class="modal-btn modal-btn-cancel" onclick="cancelDelete()">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="modal-btn modal-btn-confirm" onclick="executeDelete()">
                    <i class="fas fa-trash"></i>
                    Excluir
                </button>
            </div>
        </div>
    </div>
    <form id="deleteForm" method="post" style="display: none;">
        @Html.AntiForgeryToken()
    </form>

    <script>
        let pollIdToDelete = null;
        const searchInput = document.getElementById('searchInput');
        const pollsGrid = document.getElementById('pollsGrid');

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const pollCards = document.querySelectorAll('.poll-card');

            pollCards.forEach(card => {
                const pollQuestion = card.getAttribute('data-poll-question');
                if (pollQuestion.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
        function confirmDelete(pollId, pollQuestion) {
            pollIdToDelete = pollId;
            document.getElementById('pollToDelete').textContent = pollQuestion;
            document.getElementById('deleteModal').classList.add('active');
        }

        function cancelDelete() {
            pollIdToDelete = null;
            document.getElementById('deleteModal').classList.remove('active');
        }

        function executeDelete() {
            if (pollIdToDelete) {
                const form = document.getElementById('deleteForm');
                form.action = '@Url.Action("Excluir")/' + pollIdToDelete;
                form.submit();
            }
        }
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelDelete();
            }
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cancelDelete();
            }
        });
    </script>
</body>
</html>